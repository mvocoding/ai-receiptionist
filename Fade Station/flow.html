<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fade Station Â· Flow Builder</title>
  <meta name="description" content="Build AI Conversation Flows">
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%23000000'/%3E%3Cpath d='M40 80c8 10 40 10 48 0' stroke='%23ffffff' stroke-width='10' stroke-linecap='round' fill='none'/%3E%3Crect x='50' y='34' width='28' height='38' rx='14' fill='%23ffffff'/%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["-apple-system", "BlinkMacSystemFont", "SF Pro Text", "Inter", "system-ui", "Segoe UI", "Roboto", "Helvetica Neue", "Arial", "Noto Sans"]
          },
          colors: {
            ios: {
              bg: "#0a0a0a",
              card: "#111111",
              card2: "#0d0d0d",
              accent: "#0ea5e9",
              accent2: "#22d3ee",
              border: "#1f1f1f",
              textMuted: "#9ca3af"
            }
          },
          boxShadow: {
            glow: "0 0 0 1px rgba(255,255,255,0.04), 0 10px 30px rgba(0,0,0,0.45)",
          }
        }
      },
      darkMode: 'class'
    }
  </script>
  <style>
    #canvas {
      background-image:
        radial-gradient(circle, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px);
      background-size: 20px 20px, 20px 20px;
    }

    .node {
      cursor: move;
      user-select: none;
    }

    .node.selected {
      box-shadow: 0 0 0 2px #0ea5e9, 0 0 20px rgba(14, 165, 233, 0.3);
    }

    .connection-line {
      pointer-events: none;
      stroke: #0ea5e9;
      stroke-width: 2;
      fill: none;
      marker-end: url(#arrowhead);
    }

    .port {
      cursor: pointer;
      transition: all 0.2s;
    }

    .port:hover {
      r: 8;
      fill: #0ea5e9;
    }
  </style>
</head>

<body class="min-h-screen bg-black text-white font-sans">
  <div class="h-screen flex flex-col">
    <!-- Header -->
    <header class="border-b border-ios-border bg-black/80 backdrop-blur-md z-50">
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a href="landing.html" class="flex items-center gap-3 hover:opacity-80 transition">
            <div
              class="h-8 w-8 rounded-xl bg-white/10 flex items-center justify-center backdrop-blur-md border border-white/10">
              <span class="text-xs font-semibold">FS</span>
            </div>
            <div>
              <h1 class="text-lg font-semibold tracking-tight">Flow Builder</h1>
              <p class="text-xs text-ios-textMuted">AI Conversation Design</p>
            </div>
          </a>
        </div>
        <div class="flex items-center gap-2">
          <a href="landing.html"
            class="px-3 py-1.5 rounded-xl text-xs text-ios-textMuted hover:text-white transition">Home</a>
          <a href="index.html"
            class="px-3 py-1.5 rounded-xl text-xs text-ios-textMuted hover:text-white transition">Recordings</a>
          <a href="communications.html"
            class="px-3 py-1.5 rounded-xl text-xs text-ios-textMuted hover:text-white transition">Messages</a>
          <a href="barbers.html"
            class="px-3 py-1.5 rounded-xl text-xs text-ios-textMuted hover:text-white transition">Barbers</a>
          <a href="training.html"
            class="px-3 py-1.5 rounded-xl text-xs text-ios-textMuted hover:text-white transition">Training</a>
          <a href="demo.html"
            class="px-3 py-1.5 rounded-xl text-xs text-ios-textMuted hover:text-white transition">Demo</a>
          <button id="exportBtn"
            class="px-3 py-1.5 rounded-xl text-xs bg-emerald-500/90 hover:bg-emerald-500 transition shadow">Export
            Flow</button>
          <button id="saveBtn"
            class="px-3 py-1.5 rounded-xl text-xs bg-sky-500/90 hover:bg-sky-500 transition shadow">Save</button>
        </div>
      </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
      <!-- Left Sidebar - Node Palette -->
      <div class="w-64 border-r border-ios-border bg-ios-card overflow-y-auto">
        <div class="p-4 space-y-4">
          <div>
            <h2 class="text-sm font-semibold mb-3 text-ios-textMuted uppercase tracking-wide">Node Types</h2>

            <!-- Start Node -->
            <div draggable="true" data-type="start"
              class="node-template bg-gradient-to-br from-green-500/20 to-emerald-500/20 border border-green-500/30 rounded-xl p-3 mb-2 cursor-grab active:cursor-grabbing">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-5 h-5 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <polygon points="10,8 16,12 10,16" />
                </svg>
                <span class="text-sm font-medium">Start</span>
              </div>
              <p class="text-xs text-ios-textMuted">Conversation begins</p>
            </div>

            <!-- Message Node -->
            <div draggable="true" data-type="message"
              class="node-template bg-gradient-to-br from-blue-500/20 to-cyan-500/20 border border-blue-500/30 rounded-xl p-3 mb-2 cursor-grab active:cursor-grabbing">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-5 h-5 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                <span class="text-sm font-medium">Message</span>
              </div>
              <p class="text-xs text-ios-textMuted">AI or user message</p>
            </div>

            <!-- Condition Node -->
            <div draggable="true" data-type="condition"
              class="node-template bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/30 rounded-xl p-3 mb-2 cursor-grab active:cursor-grabbing">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-5 h-5 text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <path
                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
                <span class="text-sm font-medium">Condition</span>
              </div>
              <p class="text-xs text-ios-textMuted">If/then decision</p>
            </div>

            <!-- Action Node -->
            <div draggable="true" data-type="action"
              class="node-template bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30 rounded-xl p-3 mb-2 cursor-grab active:cursor-grabbing">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-5 h-5 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <path d="M18.36 6.64a9 9 0 1 1-12.73 0" />
                  <path
                    d="M12 2v4M12 18v4M6.64 6.64l2.83 2.83m5.06 5.06l2.83 2.83M2 12h4m12 0h4M6.64 17.36l2.83-2.83m5.06-5.06l2.83-2.83" />
                </svg>
                <span class="text-sm font-medium">Action</span>
              </div>
              <p class="text-xs text-ios-textMuted">Execute function</p>
            </div>

            <!-- End Node -->
            <div draggable="true" data-type="end"
              class="node-template bg-gradient-to-br from-red-500/20 to-rose-500/20 border border-red-500/30 rounded-xl p-3 mb-2 cursor-grab active:cursor-grabbing">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-5 h-5 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="8" y1="12" x2="16" y2="12" />
                </svg>
                <span class="text-sm font-medium">End</span>
              </div>
              <p class="text-xs text-ios-textMuted">Conversation ends</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Canvas Area -->
      <div class="flex-1 relative overflow-hidden">
        <svg id="canvas" class="absolute inset-0 w-full h-full">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#0ea5e9" />
            </marker>
          </defs>
          <g id="connections"></g>
        </svg>
        <div id="nodesContainer" class="absolute inset-0"></div>
      </div>

      <!-- Right Sidebar - Properties Panel -->
      <div id="propertiesPanel" class="w-80 border-l border-ios-border bg-ios-card overflow-y-auto hidden">
        <div class="p-4 space-y-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold uppercase tracking-wide">Properties</h2>
            <button id="closeProps" class="h-8 w-8 rounded-lg bg-white/10 hover:bg-white/15 transition">
              <svg class="h-4 w-4 m-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>

          <div id="propsContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let nodes = [];
    let connections = [];
    let nextNodeId = 1;
    let selectedNode = null;
    let draggedNode = null;
    let isConnecting = false;
    let connectingFrom = null;
    let canvasOffset = { x: 0, y: 0 };

    const nodesContainer = document.getElementById('nodesContainer');
    const connectionsGroup = document.getElementById('connections');
    const propertiesPanel = document.getElementById('propertiesPanel');
    const propsContent = document.getElementById('propsContent');

    // Node templates configuration
    const nodeConfigs = {
      start: {
        icon: `<svg class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="10,8 16,12 10,16"/></svg>`,
        color: 'from-green-500 to-emerald-500',
        inputs: 0,
        outputs: 1
      },
      message: {
        icon: `<svg class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
        color: 'from-blue-500 to-cyan-500',
        inputs: 1,
        outputs: 1
      },
      condition: {
        icon: `<svg class="w-6 h-6 text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
        color: 'from-amber-500 to-orange-500',
        inputs: 1,
        outputs: 2
      },
      action: {
        icon: `<svg class="w-6 h-6 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><path d="M12 2v4M12 18v4M6.64 6.64l2.83 2.83m5.06 5.06l2.83 2.83M2 12h4m12 0h4M6.64 17.36l2.83-2.83m5.06-5.06l2.83-2.83"/></svg>`,
        color: 'from-purple-500 to-pink-500',
        inputs: 1,
        outputs: 1
      },
      end: {
        icon: `<svg class="w-6 h-6 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`,
        color: 'from-red-500 to-rose-500',
        inputs: 1,
        outputs: 0
      }
    };

    // Create a new node
    function createNode(type, x, y) {
      const config = nodeConfigs[type];
      if (!config) return;

      const node = {
        id: `node_${nextNodeId++}`,
        type,
        x,
        y,
        width: 180,
        height: 120,
        text: '',
        ...(type === 'message' && { text: 'Enter message...' }),
        ...(type === 'condition' && { text: 'If condition...' }),
        ...(type === 'action' && { text: 'Action...' })
      };

      nodes.push(node);
      renderNodes();
      selectNode(node);
    }

    // Render all nodes
    function renderNodes() {
      nodesContainer.innerHTML = '';
      nodes.forEach(node => {
        const config = nodeConfigs[node.type];
        const nodeDiv = document.createElement('div');
        nodeDiv.className = `node absolute bg-gradient-to-br ${config.color} border-2 border-white/20 rounded-xl p-4 shadow-glow`;
        nodeDiv.style.left = node.x + 'px';
        nodeDiv.style.top = node.y + 'px';
        nodeDiv.style.width = node.width + 'px';
        nodeDiv.dataset.nodeId = node.id;

        nodeDiv.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            ${config.icon}
            <span class="text-xs font-semibold uppercase">${node.type}</span>
            <button onclick="deleteNode('${node.id}')" class="ml-auto h-6 w-6 rounded bg-black/20 hover:bg-red-500 transition">
              <svg class="w-4 h-4 m-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
          <input type="text" class="w-full bg-black/30 border border-white/20 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-white/50" 
                 value="${node.text}" onchange="updateNodeText('${node.id}', this.value)" onclick="event.stopPropagation(); selectNodeWrapper('${node.id}')"/>
          <div class="mt-2 flex gap-2">
            ${Array.from({ length: config.inputs }).map((_, i) => `
              <div class="port-${i} port w-3 h-3 rounded-full bg-white/40 border border-white/60 -ml-3 cursor-pointer"></div>
            `).join('')}
            ${Array.from({ length: config.outputs }).map((_, i) => `
              <div class="port-${i} port w-3 h-3 rounded-full bg-sky-400 border border-white/60 ml-auto -mr-3 cursor-pointer"
                   onmousedown="startConnection(event, '${node.id}', ${i})"></div>
            `).join('')}
          </div>
        `;
        nodesContainer.appendChild(nodeDiv);

        // Add click handler to select node
        nodeDiv.addEventListener('click', (e) => {
          if (!e.target.closest('.port') && !e.target.closest('button')) {
            selectNode(node);
          }
        });
      });
      renderConnections();
    }

    // Delete a node
    function deleteNode(nodeId) {
      nodes = nodes.filter(n => n.id !== nodeId);
      connections = connections.filter(c => c.fromNode !== nodeId && c.toNode !== nodeId);
      renderNodes();
      if (selectedNode?.id === nodeId) {
        selectedNode = null;
        propertiesPanel.classList.add('hidden');
      }
    }

    // Update node text
    function updateNodeText(nodeId, text) {
      const node = nodes.find(n => n.id === nodeId);
      if (node) node.text = text;
    }

    // Select a node
    function selectNode(node) {
      selectedNode = node;
      document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
      document.querySelector(`[data-node-id="${node.id}"]`)?.classList.add('selected');
      propertiesPanel.classList.remove('hidden');
      renderProperties();
    }

    // Render properties panel
    function renderProperties() {
      if (!selectedNode) return;

      const config = nodeConfigs[selectedNode.type];
      propsContent.innerHTML = `
        <div class="space-y-4">
          <div>
            <label class="block text-xs text-ios-textMuted mb-2">Node Type</label>
            <div class="bg-white/5 border border-white/10 rounded-xl p-3 flex items-center gap-2">
              ${config.icon}
              <span class="text-sm font-medium capitalize">${selectedNode.type}</span>
            </div>
          </div>
          
          <div>
            <label class="block text-xs text-ios-textMuted mb-2">Label/Text</label>
            <textarea class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50 resize-none" rows="3" 
                      onchange="updateNodeText('${selectedNode.id}', this.value)">${selectedNode.text}</textarea>
          </div>

          ${selectedNode.type === 'message' ? `
            <div>
              <label class="block text-xs text-ios-textMuted mb-2">Speaker</label>
              <select class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50">
                <option>AI Assistant</option>
                <option>Customer</option>
              </select>
            </div>
          ` : ''}

          ${selectedNode.type === 'condition' ? `
            <div>
              <label class="block text-xs text-ios-textMuted mb-2">Condition Type</label>
              <select class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50">
                <option>Contains keyword</option>
                <option>Intent match</option>
                <option>Sentiment</option>
                <option>Custom expression</option>
              </select>
            </div>
          ` : ''}

          <div>
            <label class="block text-xs text-ios-textMuted mb-2">Position</label>
            <div class="grid grid-cols-2 gap-2">
              <input type="number" value="${selectedNode.x}" class="bg-white/5 border border-white/10 rounded-xl p-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50" placeholder="X"/>
              <input type="number" value="${selectedNode.y}" class="bg-white/5 border border-white/10 rounded-xl p-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50" placeholder="Y"/>
            </div>
          </div>
        </div>
      `;
    }

    // Start connection
    function startConnection(event, nodeId, portIndex) {
      event.stopPropagation();
      if (isConnecting && connectingFrom) {
        // Complete the connection
        const conn = {
          id: `conn_${Date.now()}`,
          fromNode: connectingFrom.nodeId,
          toNode: nodeId,
          fromPort: connectingFrom.portIndex,
          toPort: portIndex
        };
        connections.push(conn);
        isConnecting = false;
        connectingFrom = null;
        document.body.style.cursor = '';
        renderNodes();
      } else {
        isConnecting = true;
        connectingFrom = { nodeId, portIndex };
        document.body.style.cursor = 'crosshair';
      }
    }

    // Cancel connection on canvas click
    nodesContainer.addEventListener('click', (e) => {
      if (e.target === nodesContainer || e.target.closest('svg')) {
        if (isConnecting) {
          isConnecting = false;
          connectingFrom = null;
          document.body.style.cursor = '';
        }
        selectedNode = null;
        propertiesPanel.classList.add('hidden');
        document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
      }
    });

    // Render connections
    function renderConnections() {
      connectionsGroup.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#0ea5e9" /></marker></defs>';

      connections.forEach(conn => {
        const fromNode = nodes.find(n => n.id === conn.fromNode);
        const toNode = nodes.find(n => n.id === conn.toNode);

        if (fromNode && toNode) {
          const x1 = fromNode.x + fromNode.width;
          const y1 = fromNode.y + 60;
          const x2 = toNode.x;
          const y2 = toNode.y + 60;

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', `M ${x1} ${y1} C ${x1 + 50} ${y1}, ${x2 - 50} ${y2}, ${x2} ${y2}`);
          path.setAttribute('class', 'connection-line');
          path.dataset.connectionId = conn.id;
          connectionsGroup.appendChild(path);
        }
      });
    }

    // Create demo flow
    function createDemoFlow() {
      nodes = [];
      connections = [];

      // Start node
      const start = {
        id: 'node_1',
        type: 'start',
        x: 50,
        y: 50,
        width: 180,
        height: 120,
        text: 'Call arrives'
      };
      nodes.push(start);

      // AI greeting message
      const greeting = {
        id: 'node_2',
        type: 'message',
        x: 300,
        y: 50,
        width: 180,
        height: 120,
        text: "Hi! My name is Angela from Fade Station barbershop. How are you today?"
      };
      nodes.push(greeting);

      // Customer response question
      const question = {
        id: 'node_3',
        type: 'condition',
        x: 550,
        y: 50,
        width: 180,
        height: 120,
        text: 'Customer responds'
      };
      nodes.push(question);

      // Booking path
      const booking = {
        id: 'node_4',
        type: 'action',
        x: 800,
        y: 20,
        width: 180,
        height: 120,
        text: 'Check availability & book'
      };
      nodes.push(booking);

      // End booking
      const end1 = {
        id: 'node_5',
        type: 'end',
        x: 1050,
        y: 20,
        width: 180,
        height: 120,
        text: 'Confirmation sent'
      };
      nodes.push(end1);

      // FAQ path
      const faq = {
        id: 'node_6',
        type: 'action',
        x: 800,
        y: 100,
        width: 180,
        height: 120,
        text: 'Provide information'
      };
      nodes.push(faq);

      // End FAQ
      const end2 = {
        id: 'node_7',
        type: 'end',
        x: 1050,
        y: 100,
        width: 180,
        height: 120,
        text: 'Conversation ends'
      };
      nodes.push(end2);

      // Create connections
      connections.push(
        { id: 'conn_1', fromNode: 'node_1', toNode: 'node_2', fromPort: 0, toPort: 0 },
        { id: 'conn_2', fromNode: 'node_2', toNode: 'node_3', fromPort: 0, toPort: 0 },
        { id: 'conn_3', fromNode: 'node_3', toNode: 'node_4', fromPort: 0, toPort: 0 },
        { id: 'conn_4', fromNode: 'node_4', toNode: 'node_5', fromPort: 0, toPort: 0 },
        { id: 'conn_5', fromNode: 'node_3', toNode: 'node_6', fromPort: 1, toPort: 0 },
        { id: 'conn_6', fromNode: 'node_6', toNode: 'node_7', fromPort: 0, toPort: 0 }
      );

      nextNodeId = 8;
      renderNodes();
    }

    // Drag and drop from palette
    document.querySelectorAll('.node-template').forEach(template => {
      template.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('nodeType', template.dataset.type);
      });
    });

    nodesContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    nodesContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      const nodeType = e.dataTransfer.getData('nodeType');
      const rect = nodesContainer.getBoundingClientRect();
      const x = e.clientX - rect.left + canvasOffset.x;
      const y = e.clientY - rect.top + canvasOffset.y;
      createNode(nodeType, x, y);
    });

    // Node dragging within canvas
    nodesContainer.addEventListener('mousedown', (e) => {
      if (e.target.closest('.port')) return;

      const nodeElement = e.target.closest('.node');
      if (nodeElement) {
        draggedNode = nodeElement;
        const startX = e.clientX;
        const startY = e.clientY;
        const node = nodes.find(n => n.id === nodeElement.dataset.nodeId);
        const offsetX = startX - node.x;
        const offsetY = startY - node.y;

        const onMouseMove = (e) => {
          node.x = e.clientX - offsetX + canvasOffset.x;
          node.y = e.clientY - offsetY + canvasOffset.y;
          renderNodes();
        };

        const onMouseUp = () => {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
          draggedNode = null;
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      }
    });

    // Close properties panel
    document.getElementById('closeProps').addEventListener('click', () => {
      propertiesPanel.classList.add('hidden');
      selectedNode = null;
      document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
    });

    // Export button
    document.getElementById('exportBtn').addEventListener('click', () => {
      const flow = { nodes, connections };
      console.log(JSON.stringify(flow, null, 2));
      alert('Flow exported to console! Check browser console for JSON.');
    });

    // Save button
    document.getElementById('saveBtn').addEventListener('click', () => {
      const flow = { nodes, connections };
      localStorage.setItem('fadeStationFlow', JSON.stringify(flow));
      alert('Flow saved to localStorage!');
    });

    // Initialize
    const savedFlow = localStorage.getItem('fadeStationFlow');
    if (savedFlow) {
      try {
        const flow = JSON.parse(savedFlow);
        nodes = flow.nodes || [];
        connections = flow.connections || [];
        if (nodes.length > 0) nextNodeId = Math.max(...nodes.map(n => parseInt(n.id.split('_')[1]))) + 1;
        renderNodes();
      } catch (e) {
        console.error('Failed to load saved flow', e);
        // Fallback to demo flow if saved flow fails
        createDemoFlow();
      }
    } else {
      // Create demo flow if no saved flow
      createDemoFlow();
    }

    // Wrapper function for selecting nodes
    function selectNodeWrapper(nodeId) {
      const node = nodes.find(n => n.id === nodeId);
      if (node) selectNode(node);
    }

    // Make functions global
    window.deleteNode = deleteNode;
    window.updateNodeText = updateNodeText;
    window.startConnection = startConnection;
    window.selectNodeWrapper = selectNodeWrapper;
  </script>
</body>

</html>